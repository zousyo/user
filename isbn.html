<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="text/javascript" src="https://serratus.github.io/quaggaJS/examples/js/quagga.min.js"></script>
    <script>
        const durl = "https://script.google.com/macros/s/AKfycbxvS9JmRMQXRle4fh_tbYzd3_nOwVRadU2Ab0lj23sBtJkChT38rnqpMIDqVjgmN18S/exec";
        function search(){
        var isbn = document.getElementById('isbn').value;
        var iurl = "https://www.googleapis.com/books/v1/volumes?q=isbn:"+isbn+"&country=JP";
        fetch(iurl , {
  method: "GET",
}).then(response => response.text())
.then(text => {
    var resdiv = document.getElementById('output').innerHTML;
    var data = JSON.parse(text);
    console.log(data);
    if(!data.items){
        alert('該当書誌がありません');
        document.getElementById('outisbn').value=isbn;
    }else{
    var bookInfo = data.items[0].volumeInfo;
        document.getElementById('outisbn').value=isbn;
        document.getElementById('title').value=bookInfo.title;
        document.getElementById('authors').value=bookInfo.authors;
        document.getElementById('categories').value=bookInfo.categories;
        document.getElementById('publishedDate').value=bookInfo.publishedDate;
        document.getElementById('description').value=bookInfo.description;
    }
})
        }

        function sub(){
        var values ={};
        var isbn = document.getElementById('outisbn').value;
        var title = document.getElementById('title').value;
        var author = document.getElementById('authors').value;
        var categorie = document.getElementById('categories').value;
        var publish = document.getElementById('publishedDate').value;
        var descript = document.getElementById('description').value;

        values["isbn"]=isbn;
        values["title"]=title;
        values["author"]=author;
        values["categorie"]=categorie;
        values["publish"]=publish;
        values["descript"]=descript;
        console.log(values);

        var confirm =window.confirm("送信します");
    if(confirm){
        var url =durl+'?page=add&name=master&mail=master&values='+JSON.stringify(values);
        console.log(url);
        fetch(url , {
  method: "GET",
}).then(response => response.text())
.then(text => {
        console.log(text);
    if(text=='success'){
        alert('登録されました');
        location.reload();
    }else if(text=='already'){
        alert('既に登録されています');
    }
})
    }
        }
        function load(){
            document.getElementById('interactive').classList.add("center");
      Quagga.init({
        inputStream: { type : 'LiveStream' },
          decoder: {
            readers: [{
              format: 'ean_reader',
              config: {}
            }]
          }
        }, (err) => {
          if(!err) {
            Quagga.start();
          }
        });
  
      Quagga.onDetected((result) => {
        var code = result.codeResult.code;
        if(code[0]==9){
        document.getElementById('isbn').value=code;
        document.getElementById('interactive').style.display="none";
        document.getElementById('interactive').classList.remove("center");
        var button =document.getElementById('load');
        button.disabled = true;
        Quagga.stop();
        search();
        }else{}
      });
    }
    </script>
    <style>
        .center{
        width:80%;
        height:80%;
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%,-50%);
        }
    </style>

    <title>Document</title>
</head>
<body>
    <label for="isbn">isbn入力</label>
    <input type="text" id="isbn">
    <button type="button" onclick="search()">検索</button>
    <div id="output"></div>
    <table border="1">
        <tr>
            <td>isbn</td><td><input type="number" id="outisbn"></td>
        </tr>
        <tr>
            <td>書名</td><td><input type="text"id="title"></td>
        </tr>
        <tr>
        <td>著者</td><td><input type="text" id="authors"></td>
        </tr>
        <tr>
        <td>カテゴリ</td><td><input type="text" id="categories"></td>
        </tr>
        <tr>
        <td>発行日</td><td><input type="text" id="publishedDate"></td>
        </tr>
        <tr>
        <td>説明</td><td><input type="text" id="description"></td>
        </tr>
    </table>
    <button type="button" onclick="sub()">送信</button>
    <button type="button" onclick="load()" id="load">ISBN読み取り</button>

    <div id="interactive" class="viewport"></div>
      
        
</body>
</html>